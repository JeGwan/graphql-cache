# Magical Apollo client! â­

ì˜ ì“°ë©´ GraphQL ë¬¸ë²•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” client-sideì˜ Databaseë‹¤!

## Cache : ì§„ì‹¤ì˜ ì›ì²œ(Source of truth)

`new InMemoryCache()`ë¡œ ì •ì˜í•œ ê²ƒì€ ê¸€ë¡œë²Œ ê°ì²´ `__APOLLO_CLIENT__`ì˜ `cache` í”„ë¡œí¼í‹°ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ ì–¸ì œë“  ì–´ë–¤ ë°ì´í„°ë“¤ì´ ìºì‰¬ë˜ì–´ìˆëŠ”ì§€ ë³¼ ìˆ˜ ìˆê³ , ê°€ì ¸ì™€ ì»´í¬ë„ŒíŠ¸ì— ë¿Œë ¤ì¤„ ìˆ˜ ìˆì–´ìš”.

`__APOLLO_CLIENT__.cache.data.data`
![image](https://media.oss.navercorp.com/user/25908/files/4bdd9e80-173a-11ec-97b1-d04d1f9797bb)

## Cache + Normalization = Client-sideì˜ ë°ì´í„°ë² ì´ìŠ¤ê°€ ë˜ë‹¤

```json
{
  "ROOT_MUTATION": { "__typename": "Mutation" },
  "ROOT_QUERY": {
    "__typename": "Query",
    "getUser({\"userId\":\"cdefg\"})": { "__ref": "User:cdefg" },
    "getUsers({})": [{ "__ref": "User:abcde" }, { "__ref": "User:cdefg" }]
  },
  "User:cdefg": {
    "id": "cdefg",
    "__typename": "User",
    "name": "í™ê¸¸ë™",
    "status": "ë‚˜ì¨",
    "totalFollowers": 20
  },
  "User:abcde": {
    "id": "abcde",
    "__typename": "User",
    "name": "ì˜¤ì œê´€",
    "status": "ì¢‹ìŒ",
    "totalFollowers": 17
  }
}
```

- í¬ê²Œ ë‘ì¶•ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
  1.  `ROOT_{QUERY|MUTATION}` ìœ¼ë¡œ ì¿¼ë¦¬ë‚˜ ë®¤í…Œì´ì…˜ì˜ ì´ë¦„ê³¼ ê²°ê³¼ë¥¼ key value pairë¡œ ì €ì¥í•©ë‹ˆë‹¤.
  2.  normalization í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ëŠ” ì°¸ì¡°ë¡œë§Œ ë‘ê³  ìµœìƒìœ„ depthë¡œ ê°€ì ¸ì™€ ë”°ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
- ì•„í´ë¡œ í´ë¼ì´ì–¸íŠ¸ëŠ” typeê³¼ idí•„ë“œê°€ ìˆëŠ” ë°ì´í„°ì— í•œí•´ [normalization](https://www.apollographql.com/docs/react/caching/overview/#2-generate-cache-ids)ì„ ìë™ìœ¼ë¡œ í•´ì¤ë‹ˆë‹¤.
- ì´ë¥¼ í†µí•´ ì •ë§ DBì²˜ëŸ¼ ë°ì´í„°ì˜ ì¤‘ë³µì„ ì¤„ì´ê³ , nestedëœ ë ˆì½”ë“œë¥¼ ì˜¤ë¡œì§€ ì°¸ì¡°ë§Œ í•˜ê²Œ í•˜ì—¬ í•˜ë‚˜ì˜ ë°ì´í„°ë¥¼ ì˜¤ë¡œì§€ í•˜ë‚˜ì˜ ë ˆì½”ë“œë¡œ ê´€ë¦¬í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.
- í•µì‹¬ì€ `__typename` + `id`(or `_id`) ë¡œ ë ˆì½”ë“œë¥¼ êµ¬ë¶„í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
- ë•Œë¬¸ì— `id`ê°€ ì—†ëŠ” ê°ì²´ë“¤ì€ ìºì‹±í•´ë†”ë„ ë‹¤ë¥¸ ê³³ê³¼ ê³µìœ ê°€ ì•ˆë©ë‹ˆë‹¤.(ì •í™•íˆ ë§í•˜ë©´ normalizationì´ ì•ˆë©ë‹ˆë‹¤. ê·¸ë˜ì„œ í•œìª½ì—ì„œ mutationìœ¼ë¡œ ë°”ê¿”ë„ ë‹¤ë¥¸ ëª¨ë“  ê³³ì—ì„œ ê·¸ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
- ëª¨ë“  ì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ cache objectì— ì €ì¥ë©ë‹ˆë‹¤.
- ë®¤í…Œì´ì…˜ì˜ ê²°ê³¼ë¡œ type + idë¥¼ ì½ì„ ìˆ˜ ìˆìœ¼ë©´, ë”°ë¡œ ë¬´ì–¸ê°ˆ í•˜ì§€ ì•Šì•„ë„ í•´ë‹¹ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ ì‹œì¼œì¤ë‹ˆë‹¤.

> ì¿¼ë¦¬ì˜ ê²°ê³¼ëŠ” normalized ë˜ì„œ ì €ì¥ë˜ê³ , ë®¤í…Œì´ì…˜ì˜ ê²½ìš° ë°˜í™˜ê°’ì´ normalizationë  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì˜¨ë‹¤ë©´(type+id)
> ë†€ëê²Œë„ apollo-clientëŠ” refetch ì—†ì´ ë°”ë¡œ í•´ë‹¹ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ ì‹œì¼œì¤€ë‹¤.
> ì¦‰ id 3ë²ˆì˜ ìœ ì €ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  mutaitonì´ ì—…ë°ì´íŠ¸ëœ ìœ ì €ë¥¼ ë¦¬í„´í•œë‹¤ë©´, apollo-clientëŠ” ìºì‹œì˜ User:3ì„ ë®¤í…Œì´ì…˜ì˜ ê²°ê³¼ë¡œë¶€í„° ì—…ë°ì´íŠ¸ ì‹œí‚¨ë‹¤. ë•Œë¬¸ì— ì¿¼ë¦¬ë¡œ User:3ì„ ë°”ë¼ë³´ê³ ìˆë˜ ì»´í¬ë„ŒíŠ¸ë“¤ë„ ì—…ë°ì´íŠ¸ê°€ ëœë‹¤.
> ë§¤ë²ˆ mutation ì§ˆì˜ë¥¼ ë‚ ë¦¬ê³ , contextë¡œë¶€í„° refetchë¥¼ ë‚´ë ¤ë°›ì•„ì„œ ì‹¤í–‰í•˜ê³ ... ì´ëŸ° ê²ƒì„ ì•ˆí•´ë„ ëœë‹¤!!

## fetchPolicyì™€ cache

![Apollo-5](https://media.oss.navercorp.com/user/25908/files/5c772e80-17a5-11ec-93ab-f1b08adeeb90)

- `cache-first`(default) : ìºì‰¬ì— ëŒ€í•´ ì§ˆì˜ => (ìˆìœ¼ë©´) ë¦¬í„´! => (ì—†ìœ¼ë©´) ë„¤íŠ¸ì›Œí¬ ì§ˆì˜ => ì‘ë‹µì„ ìºì‰¬ì— ì €ì¥ => ë¦¬í„´!
- `cache-only` : ìºì‰¬ì— ëŒ€í•´ ì§ˆì˜ => (ìˆìœ¼ë©´) ë¦¬í„´! => (ì—†ìœ¼ë©´) throw!
- `cache-and-network` : ìºì‰¬ì— ëŒ€í•´ ì§ˆì˜ => (ìˆìœ¼ë©´) ì¼ë‹¨ ë¦¬í„´! => (ìˆë“  ì—†ë“ ) ë„¤íŠ¸ì›Œí¬ ì§ˆì˜ => ì‘ë‹µì„ ìºì‰¬ë‘ ë¹„êµí•´ë´„ => ë‹¬ë¼ì¡Œìœ¼ë©´ ìºì‰¬ê°’ ì—…ë°ì´íŠ¸ => í•´ë‹¹ ìºì‰¬ë¥¼ ê°€ì ¸ë‹¤ ì“°ëŠ” ë…€ì„ë“¤ ë‹¤ ì—…ë°ì´íŠ¸ë¨!
- `network-only` : ë°”ë¡œ ë„¤íŠ¸ì›Œí¬ ì§ˆì˜ => ì‘ë‹µì„ ìºì‰¬ì— ì €ì¥ => ë¦¬í„´!
- `no-cache` : ë°”ë¡œ ë„¤íŠ¸ì›Œí¬ ì§ˆì˜ => ë¦¬í„´!

### cache

ìºì‰¬ ë ˆì´ì–´ëŠ” ì¼ì¢…ì˜ ë¦¬ë•ìŠ¤ storageë¼ê³  ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ë°ì´í„°ë¥¼ ê°€ì ¸ë‹¤ ì“°ëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì€ ë°ì´í„°ì˜ ì—…ë°ì´íŠ¸ì— ì¦‰ê° ë¦¬ë Œë”ë§ ë©ë‹ˆë‹¤.
- ìˆ˜ì‹ í•˜ëŠ” ë°ì´í„°ì˜ ë³€í™”ì—ë§Œ ë¦¬ë Œë”ë§ë©ë‹ˆë‹¤. ì´ì ì—ì„œ Context APIë³´ë‹¤ í¬ê²Œ ì½”ìŠ¤íŠ¸ê°€ ê°ì†Œí•©ë‹ˆë‹¤.
- ë¦¬ë•ìŠ¤ì˜ dispatch ê°™ì€ ì—­í• ì„ ë‹¤ìŒì²˜ëŸ¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - mutationì„ í†µí•´ (ë¦¬í„´ê°’ì´ type + idë¡œ ì˜ ì˜¨ë‹¤ë©´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
  - writeQueryë¥¼ í†µí•´

ìºì‰¬ëŠ” ì–´ë–¤ê²Œ ìˆì„ì§€ ì„ ì–¸ì ìœ¼ë¡œ ì•Œ ìˆ˜ëŠ” ì—†ìœ¼ë‚˜, í˜ì´ì§€ ë‚´ì—ì„œ ë¨¼ì € í˜ì¹­í•˜ëŠ” ë°ì´í„°ë¥¼ ì•Œ ìˆ˜ëŠ” ìˆìŠµë‹ˆë‹¤. ë¨¼ì € í˜ì¹­í•˜ëŠ” ê²ƒì„ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ë“¤ì´ ìˆ˜ì‹ (cacheë¡œ ì½ê¸°)í•˜ëŠ” êµ¬ì¡°ë¡œ ê°„ë‹¤ë©´ í•œë²ˆì˜ networkìš”ì²­ìœ¼ë¡œ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë“¤ì´ ê·¸ë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì§„ì§œ Context ë‹¤ ëŒ€ì²´ ë¼? ë¡œì»¬ì—ì„œë§Œ ì´ë¤„ì§€ëŠ” ê±´ ì–´ë–¡í•˜ê²Œ??

ë¡œì»¬ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ì„œ ì“°ë©´ë©ë‹ˆë‹¤! ğŸ‘‰ [ì—¬ê¸°](https://www.apollographql.com/docs/react/local-state/managing-state-with-field-policies/)

## ì˜ í™œìš©í•˜ê¸° ìœ„í•´ ì§€ì¼œì•¼í•  ê²ƒë“¤

![Apollo-3](https://media.oss.navercorp.com/user/25908/files/2a180200-17a2-11ec-8f0b-a40a53dba0be)

1. ì •ê·œí™”ë¥¼ ì§€ì¼œì•¼ í•œë‹¤. ë ˆì½”ë“œëŠ” `{__typename}:{id}`ë¡œ ê´€ë¦¬ëœë‹¤ëŠ” ê²ƒì„ ìŠì§€ë§ì. í•˜ë‚˜ì˜ Entityì˜ PKì— í•´ë‹¹í•˜ëŠ” IDì— í•´ë‹¹ Entityê°€ ë¬¶ì—¬ìˆì–´ì•¼í•œë‹¤.(ê¼­ `id` ë˜ëŠ” `_id`ì¼ í•„ìš”ëŠ” ì—†ë‹¤. `typePolicy`ì˜ `keyField`ë¡œ ì§€ì •í•´ì¤„ ìˆ˜ ìˆë‹¤, https://www.apollographql.com/docs/react/caching/cache-configuration/#customizing-cache-ids)

2. mutationì˜ ê²°ê³¼ëŠ” `id`ë¥¼ ê°€ì§„ í•´ë‹¹ íƒ€ì…ì„ ë¦¬í„´í•˜ê²Œ => refetchë¥¼ ì„ ì–¸í•˜ì§€ ì•Šê³ ë„ ìë™ ë°˜ì˜ë˜ë²„ë¦´ ìˆ˜ ìˆë‹¤!

3. Pageì—ì„œë§Œ networkë¥¼ íƒ€ê³  ë‚˜ë¨¸ì§€ëŠ” cacheë¡œ\
   context apiì˜ ëŒ€ì²´ => pageì—ì„œ í˜ì¹­, context api ì“°ë˜ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ëŠ” cache-firstë¡œ í•„ìš”í•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

4. êµ¬ë¶„ì„ ì˜í•˜ì. ë¬´ì¡°ê±´ useQueryë¡œ ì ‘ê·¼í•  í•„ìš”ëŠ” ì—†ë‹¤. ë¦¬ìŠ¤íŠ¸ í•˜ìœ„ì˜ ì•„ì´í…œì˜ ê²½ìš° ì´ëŸ¬í•œ ë°ì´í„°ë¥¼ propsë¡œë§Œ ë°›ëŠ”ê²Œ ì í•©í•˜ë‹¤.

```json
{
  "User:abcde": {
    "id": "abcde",
    "__typename": "User",
    "name": "ì˜¤ì œê´€",
    "status": "ì¢‹ìŒ",
    "totalFollowers": 10,
    "thumbnail": "https://item.kakaocdn.net/do/a1866850b14ae47d0a2fd61f409dfc057154249a3890514a43687a85e6b6cc82"
  },
  "User:cdefg": {
    "id": "cdefg",
    "__typename": "User",
    "name": "í™ê¸¸ë™",
    "status": "ë‚˜ì¨",
    "totalFollowers": 11,
    "thumbnail": "https://img1.daumcdn.net/thumb/C500x500.fpng/?fname=http://t1.daumcdn.net/brunch/service/user/6qYm/image/eAFjiZeA-fGh8Y327AH7oTQIsxQ.png"
  },
  "ROOT_QUERY": {
    "__typename": "Query",
    "getUser({\"userId\":\"abcde\"})": { "__ref": "User:abcde" },
    "getUsers({})": [{ "__ref": "User:abcde" }, { "__ref": "User:cdefg" }],
    "getLegacyUser({\"userId\":\"abcde\"})": {
      "__typename": "LegacyUser",
      "idNo": "abcde",
      "name": "ìš°ì™•ğŸ˜ƒ"
    }
  }
}
```
